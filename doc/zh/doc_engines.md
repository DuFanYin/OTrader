# 系统架构

## 概述

OTrader是一个采用模块化引擎架构构建的复杂期权交易平台。系统使用事件驱动设计模式，引擎通过集中式事件系统进行通信，实现松耦合和高可扩展性。

## 工作流程总结

**IbGateway** - 处理订单管理和合约查询。我们需要保留所有Interactive Brokers中可用期权列表的本地引用。

**DatabaseEngine** - 将期权列表存储在本地数据库中，并存储运行系统时生成的交易/订单数据。

**MarketDataEngine** - 获取所有合约并按策略访问将它们分组到投资组合数据中。它持续从Tradier获取实时市场数据并将实时数据注入到投资组合对象中。

**StrategyEngine** - 管理策略生命周期，为子引擎提供包装方法以相互调用。按策略管理活跃订单并缓存所有订单和交易数据。

**ComboBuilder** - 将期权数据作为输入并返回构建的期权组合。

**PositionEngine** - 为每个策略维护一个策略持仓实例。响应交易和订单事件以更新持仓，并响应定时器事件以重新计算指标。还提供关闭持仓的辅助方法。

**HedgeEngine** - 由需要策略注册的自动Delta对冲。读取持仓数据以获取Delta值，计划对冲并使用策略实例订单辅助来放置标的交易。

**OptionStrategyTemplate** - 将所有系统功能集成到其中。提供选择链以订阅实时数据的实用程序，极其简单的订单辅助来放置标的、期权和组合期权交易。

## 系统架构

![OTrader Core Class Diagram](graph/design.svg)

## 自定义扩展

模块化架构让你可以轻松扩展和自定义系统：

- **替换市场数据引擎**：将 Tradier 替换为其他数据提供商（彭博、路透等）
- **添加新的组合类型**：扩展 ComboBuilder 以支持更多期权策略
- **增强投资组合数据**：添加内置方法以实现更高效的期权选择逻辑
- **创建自定义引擎**：插入新引擎或修改现有引擎以满足你的需求

系统设计灵活且可扩展，让你可以根据特定的交易需求进行适配。

## 主引擎 - 系统编排器
**目的**：管理所有子系统的中央协调器，提供统一接口

**主要职责**：
- 初始化和协调所有引擎
- 提供统一网关接口（连接、断开、发送订单等）
- 主要引擎在main中暴露其公共方法，供彼此调用

## 事件引擎 - 通信中心
**目的**：集中式事件分发系统，实现引擎间的松耦合

**主要职责**：
- 将事件分发给注册的处理器
- 为周期性操作生成定时器事件
- 管理事件队列和线程
- 支持特定事件类型处理器和通用处理器

## 日志引擎 - 集中日志
**目的**：所有引擎的统一日志系统

**主要职责**：
- 处理来自所有引擎的日志事件
- 输出到控制台、文件和WebSocket
- 支持不同日志级别（DEBUG、INFO、WARNING、ERROR、CRITICAL）
- 使用loguru提供高级日志功能

**功能**：
- 多级别日志和结构化输出
- 每日日志文件轮转
- 网关特定日志跟踪
- WebSocket集成实现实时日志

## 数据库引擎 - 数据持久化
**目的**：交易数据和系统状态的持久化存储

**主要职责**：
- 存储订单数据、交易数据和合约信息，交易所可用合约列表
- 提供线程安全的数据库操作
- 管理SQLite数据库连接
- 支持数据序列化和恢复
- 加载合约数据并为市场引擎生成合约事件以构建投资组合

## IB网关 - 交易接口
**目的**：与Interactive Brokers（IB）的接口，用于订单执行和账户管理

**主要职责**：
- 连接到IB TWS/网关
- 执行订单和管理订单生命周期
- 查询账户和持仓信息
- 在IB和内部数据格式之间转换
- 处理合约发现和缓存

## 市场数据引擎 - 独立市场数据提供者
**目的**：独立的市场数据提供者，与策略引擎自主运行

**主要职责**：
- 管理投资组合数据容器，在数据库加载合约时构建投资组合数据
- 从Tradier API获取市场数据，带速率限制
- 注册和注销策略活跃链
- 跟踪活跃期权链，按策略和投资组合分组
- 形成数据对象并注入到投资组合数据中

**功能**：
- Tradier API集成，带速率限制（60次/分钟）
- 实时希腊字母数据（Delta、Gamma、Theta、Vega、IV）
- 与策略引擎独立运行
- 投资组合数据组织和管理

## 期权策略引擎 - 策略管理
**目的**：期权交易策略的中央枢纽

**主要职责**：
- 加载和管理策略类
- 为策略实例提供订单包装器，创建订单请求并传递给网关
- 管理策略生命周期（初始化、启动、停止、恢复、移除、删除）
- 与子引擎协调：组合构建器、持仓和对冲
- 策略持仓和策略数据持久化，保存和加载
- 转发交易和订单数据给持仓引擎管理持仓

**功能**：
- 多策略并发执行
- 从配置文件恢复策略
- 事件驱动策略执行
- 全面的错误处理和策略隔离

## 持仓引擎 - 持仓管理
**目的**：管理每个策略的持仓和持仓操作

**主要职责**：
- 跟踪策略特定持仓：标的资产、单腿期权和组合期权
- 基于交易和订单更新持仓数据
- 序列化/反序列化持仓数据
- 通过将订单映射到交易来组织组合持仓及其腿
- 提供持仓相关数据查询

**功能**：
- 实时持仓跟踪
- 多腿组合持仓管理
- 跨持仓的希腊字母聚合
- 盈亏跟踪（已实现和未实现）
- 持仓数据持久化和恢复

## 对冲引擎 - 风险管理
**目的**：风险管理的集中对冲系统

**主要职责**：
- 提供策略Delta对冲
- 注册策略进行对冲
- 监控Delta敞口并执行对冲订单
- 管理对冲订单生命周期
- 提供风险管理控制

**功能**：
- 自动Delta中性对冲
- 多策略对冲管理
- 实时Delta监控
- 智能对冲订单执行
- 可配置的Delta目标和范围

## 组合构建引擎
**目的**：策略实例的辅助组件，用于轻松构建组合订单

- 支持数十种订单组合类型
- 检索合约并使用可区分签名构建组合
